@model SacramentMeetingPlanner.Models.SacramentMeetingView

@{
    ViewData["Title"] = "Create";
}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<h1>Create</h1>

<h4>SacramentMeeting</h4>
<hr />
<div id="hymn-string" style="display:none" data-value="@Model.Hymns"></div>
<div id="event-type-string" style="display:none" data-value="@Model.EventTypes"></div>
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create" method="post">
             <div class="form-group">
                <label asp-for="SacramentMeetingDate" class="control-label"></label>
                <input asp-for="SacramentMeetingDate" asp-format="{0:yyyy-MM-dd}" class="form-control" value=@DateTime.Now/>
                <span asp-validation-for="SacramentMeetingDate" class="text-danger"></span>
            </div>
            @Html.EditorFor(meeting => meeting.EventList)
            <div class="form-group" id="event-list">
            </div>
            <a href="#" id="add">Add</a><br>
            <input type="submit" value="Create" class="btn btn-default" />
        </form>
    </div>
</div>
<script type="text/javascript">
    $(function () {
        $("#add").click(function (event) {
            event.preventDefault();
            var i = $("#event-list").children().length;
            var eventSelect = `
                <div id=${i} class="form-group event">
                    <select id="event-type" name="EventList[${i}].EventType"/>
                        ${document.getElementById("event-type-string").getAttribute("data-value")}
                    </select>
                    <input name="EventList[${i}].EventDescription"/>
                    <select name="EventList[${i}].Hymn"/>${document.getElementById("hymn-string").getAttribute("data-value")}</select>
                    <a href="#" id="remove">Remove</a>
                </div>`;
            $("#event-list").append(eventSelect);
        });

        $("#event-list").on("click", "#remove", function() {
            var removalId = this.parentNode.id;
            var children = $("#event-list").children()

            children.each( function() {
                if (this.id > removalId) {
                    this.id = this.id - 1
                    for (var child = 0; child < this.children.length; child++){
                        var startStr = `EventList[${this.id}].`;
                        if (this.children[child].name.includes("EventType")){
                            this.children[child].name =`${startStr}EventType`;
                        } else if (this.children[child].name.includes("EventDescription")){
                            this.children[child].name =`${startStr}EventDescription`;
                        } else if (this.children[child].name.includes("FirstName")){
                            this.children[child].name =`${startStr}FirstName`;
                        } else if (this.children[child].name.includes("LastName")){
                            this.children[child].name =`${startStr}LastName`;
                        } else if (this.children[child].name.includes("Topic")){
                            this.children[child].name =`${startStr}Topic`;
                        } else if (this.children[child].name.includes("Hymn")){
                            this.children[child].name =`${startStr}Hymn`;
                        }
                    }
                }
            })
            children[removalId].remove()
        });

        $("#event-list").on("change", "#event-type", function() {
            i = this.parentNode.id;
            var element = document.createElement(`select`);
            element.name = `EventList[${i}].Hymn`;
            element.innerHTML = document.getElementById("hymn-string").getAttribute("data-value");
            let correctFields = {
                "1" : [
                    "EventType",
                    "EventDescription",
                    "Hymn"
                ], 
                "2" : [
                    "EventType",
                    "EventDescription",
                    "FirstName",
                    "LastName"
                ],
                "3" : [
                    "EventType",
                    "EventDescription",
                    "FirstName",
                    "LastName"
                ],
                "4" : [
                    "EventType",
                    "EventDescription",
                    "FirstName",
                    "LastName",
                    "Topic"
                ]
            }

            let children = [...this.parentNode.children];
            let parent = this.parentNode;
            let remove = parent.lastElementChild;

            while (parent.firstChild) {
                parent.removeChild(parent.firstChild)
            }

            for (var element of correctFields[`${this.value}`]) {
                item = children.find(item => item.name.includes(element))
                if (typeof item !== "undefined" ) {
                    parent.appendChild(item);
                } else {
                    var elementToAdd;
                    switch (element) {
                        case "EventType":
                            elementToAdd = document.createElement(`select`);
                            elementToAdd.name = `EventList[${i}].EventType`;
                            elementToAdd.innerHTML = document.getElementById("event-type-string").getAttribute("data-value");
                            break;
                        case "EventDescription":
                            elementToAdd = document.createElement("input");
                            elementToAdd.name = `EventList[${i}].EventDescription`
                            break;
                        case "FirstName":
                            elementToAdd = document.createElement("input");
                            elementToAdd.name = `EventList[${i}].FirstName`
                            break;
                        case "LastName":
                            elementToAdd = document.createElement("input");
                            elementToAdd.name = `EventList[${i}].LastName`
                            break;
                        case "Topic":
                            elementToAdd = document.createElement("input");
                            elementToAdd.name = `EventList[${i}].Topic`
                            break;
                        case "Hymn":
                            elementToAdd = document.createElement(`select`);
                            elementToAdd.name = `EventList[${i}].Hymn`;
                            elementToAdd.innerHTML = document.getElementById("hymn-string").getAttribute("data-value");
                            break;
                    }
                    parent.appendChild(elementToAdd);
                }
            }
            parent.appendChild(remove);

        })
    });
</script>
<div>
    <a asp-action="Index">Back to List</a> 
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
